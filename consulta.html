<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel T√©cnico - Yuri Celulares</title>
<style>
:root { --primary: #007bff; --bg: #0a0a0b; --card-bg: #161b22; --text: #f0f6fc; --border: #30363d; --danger: #f85149; --success: #2ea043; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; }
input, select, textarea, button { box-sizing:border-box; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); overflow-y:auto; padding:20px; z-index:1000; }
.modal-content { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-width: 500px; margin:auto; }
.os-card { background: var(--card-bg); border:1px solid var(--border); padding:15px; margin-bottom:15px; border-radius:12px; position:relative; border-left:5px solid var(--primary); }
.status-badge { color: var(--primary); font-weight:bold; }
</style>
</head>
<body>

<div id="loginBox">
    <h2>Login T√©cnico</h2>
    <input type="email" id="email" placeholder="E-mail">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="login()">Entrar</button>
</div>

<div id="painel" style="display:none;">
    <button onclick="gerarLinkCliente()">üìã Gerar Link Cadastro Cliente</button>
    <button onclick="verRelatorioMensal()">üìä Relat√≥rio Mensal</button>
    <div class="menu-topo">
        <button onclick="carregar(false)">ATIVAS</button>
        <button onclick="carregar(true)">LIXEIRA</button>
    </div>
    <div class="search-container">
        <input type="text" id="inputBusca" placeholder="üîç Buscar por Nome, CPF ou Modelo..." onkeyup="filtrarOS()">
    </div>
    <div id="lista"></div>
</div>

<div id="modalGeral" class="modal">
    <div class="modal-content">
        <h2 id="tituloModal"></h2>
        <div id="corpoModal"></div>
        <button onclick="fecharModal()">FECHAR</button>
    </div>
</div>

<script>
let tecnicoId = null;
let osSelecionada = null;
let modoLixeira = false;

async function login() {
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;
    const res = await fetch('/login-tecnico', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,senha}) });
    if(res.status===200){
        const data = await res.json();
        tecnicoId = data.tecnicoId;
        localStorage.setItem('tecnicoId', tecnicoId);
        document.getElementById('loginBox').style.display='none';
        document.getElementById('painel').style.display='block';
        carregar(false);
    } else alert('Credenciais inv√°lidas');
}

function gerarLinkCliente() {
    const linkCadastro = `${window.location.origin}/cliente?tecnicoId=${tecnicoId}`;
    prompt("Copie o link para o cliente:", linkCadastro);
}

async function carregar(isLixeira=false) {
    modoLixeira=isLixeira;
    const res = await fetch(`/ordens/${tecnicoId}`);
    const dados = await res.json();
    document.getElementById('lista').innerHTML = dados.map(os=>{
        const lucro = (os.valor_total||0) - ((os.valor_peca||0)+(os.gasto_gasolina||0));
        return `<div class="os-card">
            <button onclick="acaoExcluir('${os.cpf}',${os.data_ms})" style="position:absolute;right:10px;top:10px;">üóëÔ∏è</button>
            <h3>${os.nome} - <small>${os.modelo}</small></h3>
            <div>üìç ${os.endereco||'N/A'} | üÜî ${os.cpf} | üì± ${os.whatsapp}</div>
            <div>üí∞ ${os.valor_total||0} | Lucro: ${lucro.toFixed(2)}</div>
            <button onclick="atualizarStatus('${os.cpf}',${os.data_ms},'Em Andamento')">EM ANDAMENTO</button>
            <button onclick="finalizarGarantia('${os.cpf}',${os.data_ms})">PRONTO/GARANTIA</button>
        </div>`;
    }).reverse().join('');
}

function filtrarOS() {
    const t = document.getElementById('inputBusca').value.toLowerCase();
    document.querySelectorAll('.os-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(t)?"block":"none");
}

async function atualizarStatus(cpf,data_ms,status){
    await fetch('/atualizar-os',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cpf,data_ms,status})});
    carregar(modoLixeira);
}

async function finalizarGarantia(cpf,data_ms){
    const dias = prompt("Dias de garantia?","90");
    if(dias) atualizarStatus(cpf,data_ms,'Pronto');
}

async function acaoExcluir(cpf,data_ms){
    if(confirm(modoLixeira?"Apagar DEFINITIVO?":"Mover para Lixeira?")){
        await fetch('/atualizar-os',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cpf,data_ms,excluido:!modoLixeira,deletarReal:modoLixeira})});
        carregar(modoLixeira);
    }
}

function fecharModal(){document.getElementById('modalGeral').style.display='none';}

async function verRelatorioMensal(){
    const res=await fetch('/relatorio-mensal');
    const r=await res.json();
    document.getElementById('tituloModal').innerText=`RELAT√ìRIO ${r.mes.toUpperCase()}`;
    document.getElementById('corpoModal').innerHTML=`Servi√ßos: ${r.servicosRealizados}<br>Bruto: ${r.totalBruto}<br>Lucro: ${r.lucroLiquido}`;
    document.getElementById('modalGeral').style.display='block';
}
</script>

</body>
</html>
